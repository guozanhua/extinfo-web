<!doctype html>
<html>
<head>
	<title>monitor // extinfo-web</title>
	<script src="http://use.edgefonts.net/open-sans.js"></script>
	<link rel="stylesheet" href="/style.css">
	<meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body onload="init();" spellcheck="false">
	<h1 id="heading">
		extinfo-web
	</h1>
	<table>
		<thead>
			<tr>
				<td>Address</td>
				<td id="addr" contenteditable spellcheck="false" onblur="updatesocket();">sauerleague.org</td>
			</tr>
			<tr>
				<td>Port</td>
				<td id="port" contenteditable spellcheck="false" onblur="updatesocket();">10000</td>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td id="description" colspan="2">&nbsp;</td>
			</tr>
			<tr>
				<td>Game Mode</td>
				<td id="gamemode"></td>
			</tr>
			<tr>
				<td>Map</td>
				<td id="map"></td>
			</tr>
			<tr>
				<td>Clients</td>
				<td><span id="numberofclients"></span>/<span id="maxnumberofclients"></span></td>
			</tr>
			<tr>
				<td>Master Mode</td>
				<td id="mastermode"></td>
			</tr>
			<tr>
				<td>Time Left</td>
				<td><span id="timeleft"></span> minutes</td>
			</tr>
		</tbody>
	</table>

	<p>what</p>
	<small>
		this is a live monitor for any <a href="http://sauerbraten.org" target="_blank">sauerbraten</a> server
	</small>

	<p>how</p>
	<small>
		try editing the server address and port fields to <i>ogros.org</i> and <i>20000</i>, and tab out of both fields
	</small>

	<p>embed</p>
	<small>
		you can embed this on your website using the <code>embed.js</code> file; an example is <a href="/demo" target="_blank">here</a>
	</small>

	<p>about</p>
	<small>
		<ul>
			<li>backend written in <a href="http://golang.org" target="_blank">go</a></li>
			<li>uses the <a href="https://github.com/sauerbraten/extinfo" target="_blank">extinfo package</a></li>
			<li>websockets â†’ no page refreshs, no ajax requests</li>
			<li>hubs group websocket connections by server; check out the <a href="/status" target="_blank">status page</a></li>
			<li>pollers run concurrently</li>
			<li>changes at one server are broadcasted to many clients</li>
			<li>update interval is 5 seconds</li>
		</ul>
	</small>

	<p>by</p>
	<small>
		pix
	</small>

	<script>
		var $ = function (id) {
			return document.getElementById(id);
		};

		var sock;
		var addr = "";
		var port = "";

		function updatesocket() {
			var newaddr = $("addr").innerHTML.replace(/<br ?\/?>/, "");
			var newport = $("port").innerHTML.replace(/<br ?\/?>/, "");

			if (newaddr == addr && newport == port) {
				return;
			}

			if (typeof(sock) != "undefined") {
				sock.close();
				sock = null;
			}

			sock = new WebSocket("ws://{{.}}/ws");

			sock.onclose = function(e) {
				console.log(" - socket closed - ");
			};

			sock.onmessage = function(m) {
				console.log("received:", m.data);
				var parts = m.data.split("\t");

				var field = parts[0];
				var value = parts[1].replace(/</g, "&lt;").replace(/>/g, "&gt;");

				switch (field) {
					case "description":
						document.title = value + " // extinfo-web";
						break;
					case "timeleft":
						var minutes = Math.floor(value/60);
						var seconds = value % 60;
						value = (minutes < 10 ? '0' : '') + minutes + ":" + (seconds < 10 ? '0' : '') + seconds;
						break;
				}

				$(field).innerHTML = value;
			};

			sock.onopen = function(e) {
				console.log(" - socket opened - ");
				sock.send(newaddr + "\t" + newport);
				console.log("sent:    ", newaddr + "\t" + newport);
			};

			addr = newaddr;
			port = newport;
			setTimeout(function() {document.title = $("description").innerHTML + " // extinfo-web"}, 500);
			setTimeout(function() {$("heading").innerHTML = $("description").innerHTML + " // extinfo-web"}, 500);
			window.location.hash = "#" + addr + ":" + port;
		}

		function init() {
			if (window.location.hash.substring(1).match(/[a-zA-Z0-9\\.]+:[0-9]+/)) {
				var parts = window.location.hash.substring(1).split(':');
				$("addr").innerHTML = parts[0];
				$("port").innerHTML = parts[1];
			}
			updatesocket();
		}
	</script>
</body>
</html>
